# üîê Ansible + Vault: –∫–æ–≥–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –Ω–µ –±–∞–≥, –∞ —Ñ–∏—á–∞

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∂–∏–≤—ë—Ç, –ø–æ–∫–∞ —Ç—ã –¥–µ—Ä–∂–∏—à—å –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –¥–æ—Å—Ç—É–ø.  
SSH-–∫–ª—é—á–∏, root-–¥–æ—Å—Ç—É–ø, offboarding, –∞—É–¥–∏—Ç, –ø–∞—Ä–∞–Ω–æ–π—è ‚Äî —Ç—ã —ç—Ç–æ —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª.  
–ê —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –Ω–µ –ø–∞—Ä–∏—à—å—Å—è.

–¢—ã –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—à—å `make deploy`, –∞ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –¥–µ–ª–∞–µ—Ç Ansible.  
–î–∞–Ω–Ω—ã–µ –±–µ—Ä—ë—Ç –∏–∑ HashiCorp Vault. –ö–ª—é—á–∏ ‚Äî –∏–∑ Vault. –î–∞–∂–µ —Ç–æ–∫–µ–Ω ‚Äî –∏–∑ —Ñ–∞–π–ª–∞.  
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä, –≥–¥–µ **–¥–æ—Å—Ç—É–ø ‚Äî —ç—Ç–æ –¥–∞–Ω–Ω—ã–µ**, –∞ **Vault ‚Äî –Ω–µ —Ä–æ—Å–∫–æ—à—å, –∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å**.

---

## üõÖ Vault ‚Äî —ç—Ç–æ –Ω–µ –±–∞–∑–∞. –≠—Ç–æ –¥–æ–≤–µ—Ä–∏–µ.

Vault –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–µ–∫—Ä–µ—Ç–∫–∞. –≠—Ç–æ **—Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞**, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Ä–µ–≤–∏–∑–∏–∏.  
–û–Ω–∞ —É–º–µ–µ—Ç –≤ ACL, TTL, revocation, audit logs. –ò –¥–∞, –æ–Ω–∞ –Ω–µ SQLite ‚Äî –æ–Ω–∞ –ø–µ—Ä–µ–∂–∏–≤—ë—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É.

> –ú—ã —Ö—Ä–∞–Ω–∏–º —Ç–∞–º SSH-–∫–ª—é—á–∏. –ü–æ –ø—É—Ç—è–º –≤–∏–¥–∞ `secrets/data/ssh_keys/admins`.  
> –ß–µ—Ç–∫–æ. –ü–æ –≥—Ä—É–ø–ø–∞–º. –ë–µ–∑ –ª–∏—à–Ω–µ–≥–æ.

---

## üóÇÔ∏è Inventory —Å –¥–≤—É–º—è –≥—Ä—É–ø–ø–∞–º–∏. –ü–æ—Ç–æ–º—É —á—Ç–æ –±—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–π –¥–æ—Å—Ç—É–ø.

```ini
[admins]
srv-admin01
srv-admin02

[dev]
srv-dev01
srv-dev02
```

- **admins** –ø–æ–ª—É—á–∞—é—Ç —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.
- **dev** –ø–æ–ª—É—á–∞—é—Ç —Å–≤–æ–∏ + –≤—Å–µ –∞–¥–º–∏–Ω—Å–∫–∏–µ.

–í—Å—ë —ç—Ç–æ ‚Äî —á–µ—Ä–µ–∑ –æ–¥–∏–Ω playbook, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –ø—É—Ç–∏ –≤ Vault –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å:

```yaml
vault_paths: "{{ vault_paths_admins + (vault_paths_developers if group == 'dev' else []) }}"
```

---

## ü™Ñ Ansible: –∂–∏–≤–æ–π YAML, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Å—Ç–∏—Ç –∑–∞ —Ç–æ–±–æ–π

```yaml
- name: Remove outdated keys
  authorized_key:
    user: root
    state: absent
```

–°–Ω–∞—á–∞–ª–∞ –¥–æ—Å—Ç–∞—ë–º –∫–ª—é—á–∏ –∏–∑ Vault. –ü–æ—Ç–æ–º —Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ —É–∂–µ –ª–µ–∂–∏—Ç –≤ `authorized_keys`.  
–£–¥–∞–ª—è–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ. –î–æ–±–∞–≤–ª—è–µ–º –≤—Å—ë –Ω—É–∂–Ω–æ–µ.  

---

##  Makefile:

```makefile
deploy:
	export VAULT_TOKEN=$(cat /root/.vault-token) && \
	ansible-playbook -i inventory.yaml upload_authorized_keys.yaml -e "group=admins keys=admins"
```

–ê –µ—â—ë `create_env`, `setup_cron`, `make deploy`.  
–î–∞, –º—ã –≤—ã–∑—ã–≤–∞–µ–º Ansible —á–µ—Ä–µ–∑ `make`. –î–∞, –º—ã –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º venv –≤–Ω—É—Ç—Ä–∏ cron.  
–î–∞, —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç. **–î–∞, —ç—Ç–æ –Ω–∞–¥—ë–∂–Ω–æ.**

---

## ‚è∞ Cron: CI/CD –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –≤—ã–∂–∏–ª

```cron
*/10 * * * * cd /opt/ssh-access && source /opt/ansible_venv/bin/activate && make deploy >> /tmp/deploy.log
```

–ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –Ω—É–∂–Ω—ã–µ –∫–ª—é—á–∏.  
–£—à—ë–ª —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî —É–¥–∞–ª–∏–ª–∏ –∏–∑ Vault ‚Äî —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –æ–Ω —É–∂–µ –Ω–µ root.  
–ù–µ –Ω—É–∂–µ–Ω GitLab. –ù–µ –Ω—É–∂–µ–Ω pipeline. –î–∞–∂–µ Ansible Tower –Ω–µ –Ω—É–∂–µ–Ω.

---

## üîÅ –ê –µ—Å–ª–∏ –∫–ª—é—á —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω?

–≠—Ç–æ —Ç–æ–∂–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ.

–ü–ª–µ–π–±—É–∫ —Å–Ω–∞—á–∞–ª–∞ **–≤—Ö–æ–¥–∏—Ç –ø–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫–ª—é—á—É**, –∑–∞–±–∏—Ä–∞–µ—Ç —Å–≤–µ–∂–∏–µ –∫–ª—é—á–∏ –∏–∑ Vault, **—É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ** –∏ **–¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ**.

> –¢–æ –µ—Å—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª—é—á —Å–ª–∏–ª–∏, —Ç—ã –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ—à—å –µ–≥–æ –≤ Vault ‚Äî –∏ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç —É –≤—Å–µ—Ö —É–∂–µ –Ω–æ–≤—ã–π.  
> –ë–µ–∑ –ª–æ–≥–∏–Ω–∞ —Ä—É–∫–∞–º–∏. –ë–µ–∑ –ø–∞–Ω–∏–∫–∏. –ë–µ–∑ –≤—ã—Ö–æ–¥–∞ –∑–∞ KPI –ø–æ SLA.

---

## üö´ –ü–∞—Ä–æ–ª—å? –£ –Ω–∞—Å –µ–≥–æ –Ω–µ—Ç.

–ó–∞–æ–¥–Ω–æ –ø–ª–µ–π–±—É–∫ **–æ—Ç–∫–ª—é—á–∞–µ—Ç –≤—Ö–æ–¥ –ø–æ–¥ root –ø–æ –ø–∞—Ä–æ–ª—é**

```ini
PermitRootLogin prohibit-password
```

> –ü—Ä–æ–±—É–µ—à—å –∑–∞–π—Ç–∏ –ø–æ –ø–∞—Ä–æ–ª—é ‚Äî –∏ –∏–¥—ë—à—å –≤ –ª–æ–≥, –≥–¥–µ —Ç–µ–±—è –∑–∞–ø–∏—Å–∞–ª–∏.  
> –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ø–æ –ø–ª–∞–Ω—É.

---

## ‚úÖ –†–µ–∑—é–º–µ

- Vault ‚Äî —ç—Ç–æ **–Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã**, —ç—Ç–æ **—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ–≤–µ—Ä–∏—è**
- –ö–ª—é—á–∏ ‚Äî –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ. –ë–µ–∑ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞.
- Ansible ‚Äî —á–∏—Å—Ç–∏—Ç –∏ –Ω–∞–≤–æ–¥–∏—Ç –ø–æ—Ä—è–¥–æ–∫
- `make deploy` ‚Äî –∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
- `cron` ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞
- –î–æ—Å—Ç—É–ø ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–∞–º –∏–∑ Vault
- –ü–∞—Ä–æ–ª—å root –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- –ü—Ä–∏ —É—Ç–µ—á–∫–µ –∫–ª—é—á–µ–π –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è—é—Ç—Å—è

---


